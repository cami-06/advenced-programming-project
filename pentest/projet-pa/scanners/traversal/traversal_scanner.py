from scanners.base_scanner import BaseScanner
from scanners.traversal.traversal_detector import TraversalDetector 
from scanners.traversal.traversal_tester import TraversalTester
from scanners.traversal.traversal_models import TraversalFinding


class TraversalScanner(BaseScanner):
    
    def __init__(self, crawler, http_client, reporter):
        super().__init__(crawler, http_client, reporter)
        self.detector = TraversalDetector()
        self.tester = TraversalTester() 
    
    def scan(self):
        """Scan rapide - teste seulement les paramètres suspects"""
        findings = []
        urls = self.crawler.get_urls()[:30]  # ⚡ Maximum 30 URLs
        
        print(f"\n[*] Traversal Scan: {len(urls)} URLs")
        
        for url in urls:
            try:
                params = self.detector.extract_parameters(url)
                if not params:
                    continue
                
                for param in params:
                    if not self.detector.is_suspicious_parameter(param):
                        continue  # Sauter les paramètres normaux
                    
                    try:
                        # ⚡ UN SEUL test (basique uniquement)
                        vulnerable, payload, evidence = self.tester.test_basic(
                            self.http_client, url, param
                        )
                        
                        if vulnerable:
                            severity = self.tester._calculate_severity(evidence)
                            
                            finding = TraversalFinding(
                                url=url,
                                parameter=param,
                                payload=payload,
                                issue="Directory Traversal",
                                severity=severity,
                                evidence=evidence,
                                traversal_type="basic",
                                method="GET"
                            )
                            
                            self.reporter.add_finding(finding)
                            findings.append(finding)
                            print(f"  [!] Vuln: {param}")
                            break  # Passer à l'URL suivante
                    except Exception as e:
                        continue
            except Exception as e:
                continue
        
        print(f"[✓] Scan terminé: {len(findings)} vulnérabilités\n")
        return findings
    
    def _determine_traversal_type(self, test_name: str) -> str:
        return "basic"
    
    def scan_with_forms(self):
        return self.scan()