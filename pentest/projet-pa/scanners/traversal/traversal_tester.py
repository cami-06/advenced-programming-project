from scanners.traversal.traversal_payloads import TRAVERSAL_PAYLOADS
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse
import re


class TraversalTester:
    
    LINUX_SIGNATURES = [
        r"root:.*:0:0:",
        r"daemon:.*:/usr/sbin",
        r"root:x:0:0:"
    ]
    
    WINDOWS_SIGNATURES = [
        r"\[extensions\]",
        r"\[fonts\]",
        r"\[boot loader\]"
    ]
    
    def __init__(self):
        pass  # ✅ AUCUN PARAMÈTRE!
    
    def _inject(self, url: str, param: str, payload: str) -> str:
        parsed = urlparse(url)
        params = parse_qs(parsed.query)
        params[param] = [payload]
        return urlunparse(parsed._replace(query=urlencode(params, doseq=True)))
    
    def test_basic(self, http, url: str, param: str):
        # ⚡ Seulement 3 payloads
        payloads = TRAVERSAL_PAYLOADS()
        
        for payload in payloads:
            try:
                injected_url = self._inject(url, param, payload)
                response = http.get(injected_url)
                
                if not response or response.status_code != 200:
                    continue
                
                for pattern in self.LINUX_SIGNATURES:
                    if re.search(pattern, response.text):
                        return True, payload, "Linux file detected"
                
                for pattern in self.WINDOWS_SIGNATURES:
                    if re.search(pattern, response.text, re.IGNORECASE):
                        return True, payload, "Windows file detected"
            except:
                continue
        
        return False, None, None
    
    def test_encoded(self, http, url: str, param: str):
        return False, None, None
    
    def test_double_encoded(self, http, url: str, param: str):
        return False, None, None
    
    def test_windows_specific(self, http, url: str, param: str):
        return False, None, None
    
    def test_linux_specific(self, http, url: str, param: str):
        return False, None, None
    
    def _calculate_severity(self, evidence: str) -> str:
        if "shadow" in evidence.lower():
            return "CRITICAL"
        if "passwd" in evidence.lower():
            return "HIGH"
        return "MEDIUM"